#!/bin/sh

FILES=`cat bench-files`

# benchmark for caduceus
export CADUCEUSLIB=`pwd`/../../lib/why
export WHYCOQ=`pwd`/../../lib/coq
make="make WHYCOQ=$WHYCOQ"

# C files to parse with success
echo "C parsing (good)"
cd good/syntax
parsing="../../../../bin/caduceus.opt -parse-only"
for f in *.c; do
    echo -n "  "$f"... "
    if ! gcc -c $f > /dev/null 2>&1; then
	echo "GCC failed"
	if test $f != "obfuscated.c" ; then
           gcc -c $f
	   exit 1
        fi
    else
      echo -n "GCC ok... "
    fi
    if ! $parsing  $f > /dev/null 2>&1; then
	echo "caduceus FAILED"
	#$parsing $f
	#exit 1
    else
	echo "caduceus ok... "
    fi
done

echo "C parsing (bad)"
cd ../../bad-syn
parsing="../../../bin/caduceus.opt -parse-only"
for f in *.c; do
    echo -n "  "$f"... "
    if gcc -c $f > /dev/null 2>&1; then
	echo "GCC failed (accepted a bad file)"
	gcc -c $f
	exit 1
    fi
    echo -n "GCC ok... "
    if $parsing  $f > /dev/null 2>&1; then
	echo "caduceus FAILED (accepted a bad file)"
	#$parsing $f
	#exit 1
    else
	echo "caduceus ok... "
    fi
done

echo "C parsing/typing (bad)"
cd ../bad-sem
parsing="../../../bin/caduceus.opt -type-only"
for f in *.c; do
    echo -n "  "$f"... "
    if gcc -c -Wall -Werror $f > /dev/null 2>&1; then
	echo "GCC failed (accepted a bad file)"
	gcc -c $f
	exit 1
    fi
    echo -n "GCC ok... "
    if $parsing  $f > /dev/null 2>&1; then
	echo "caduceus FAILED (accepted a bad file)"
	#$parsing $f
	#exit 1
    else
	echo "caduceus ok... "
    fi
done

echo "C parsing/typing (good)"
cd ../good
parsing="../../../bin/caduceus.opt -type-only"
for f in *.c; do
    echo -n "  "$f"... "
    if ! gcc -c $f > /dev/null 2>&1; then
	echo "GCC failed"
	gcc -c $f
	exit 1
    fi
    echo -n "GCC ok... "
    if ! $parsing  $f > /dev/null 2>&1; then
	echo "caduceus FAILED"
	#$parsing $f
	#exit 1
    else
	echo "caduceus ok... "
    fi
done

echo "C interp (bad)"
cd ../bad-interp
parsing="../../../bin/caduceus.opt"
for f in *.c; do
    echo -n "  "$f"... "
    if gcc -ansi -pedantic -Wall -Werror -c $f > /dev/null 2>&1; then
	echo "GCC failed (accepted a bad file, maybe not detected)"
	gcc -ansi -pedantic -Wall -Werror -c $f
    else
        echo -n "GCC ok... "
    fi
    if $parsing  $f > /dev/null 2>&1; then
	echo "caduceus FAILED (accepted a bad file)"
	#$parsing $f
	#exit 1
    else
	echo "caduceus ok... "
    fi
done

echo "C interp (good)"
cd ../good
export CADUCEUSLIB=`pwd`/../../../lib

bench_c_good () {
    options="$* -why-opt -split-user-conj " # -why-opt -show-time"  # --typing-predicates"
    echo "-------------------------------------------------------------------"
    echo "Bench Caduceus+Simplify/Yices with options: $options"
    parsing="../../../bin/caduceus.opt $options"

    rm -f why/*.why
    rm -f simplify/*_why.sx
    rm -f smtlib/*_why.smt
    VCS=""
    for f in $FILES; do
	echo -n "  Generating VCs for $f.c... "
	if $parsing  $f.c > /tmp/caduceus.tmp 2>&1; then
	    if $make -f $f.makefile simplify/${f}_why.sx > /tmp/caduceus.tmp 2>&1 ; then
		if $make -f $f.makefile smtlib/${f}_why.smt > /tmp/caduceus.tmp 2>&1 ; then
		    VCS="$VCS simplify/${f}_why.sx smtlib/${f}_why.smt"    
		    echo "ok"
		else
		    echo "why FAILED :"
		    cat /tmp/caduceus.tmp
		    exit 1
		fi
	    else
		echo "why FAILED :"
		cat /tmp/caduceus.tmp
		exit 1
	    fi
	else
	    echo "caduceus FAILED (rejected a good file) :"
	    cat /tmp/caduceus.tmp
	    exit 1
	fi
    done
    ../../../bin/dp.opt -timeout 20 $VCS 2>/dev/null || true
}

bench_c_good
bench_c_good -separation -no-zone-type

cd ../../../examples-c
make bench

# Coq proofs
# for f in $FILES; do
#     echo -n "  $f.c... "
#     rm -f coq/caduceus_spec_why.v
#     if $parsing  $f.c > /tmp/caduceus.tmp 2>&1; then
# 	echo -n "caduceus ok... "
# 	if $make -f $f.makefile coq > /tmp/caduceus.tmp 2>&1; then
# 	    n=`grep -c Admitted coq/${f}_why.v`
# 	    if test $n -ne 0 ; then
# 		echo "Coq proof ok (with $n Admitted)... "
# 	    else
# 		echo "Coq proof ok... "
# 	    fi
# 	else
# 	    echo "Coq proof FAILED !"
# 	    cat /tmp/caduceus.tmp
# 	    exit 1
# 	fi
#     else
# 	echo "caduceus FAILED (rejected a good file) :"
# 	cat /tmp/caduceus.tmp
# 	exit 1
#     fi
# done



#!/bin/sh

# benchmark for caduceus
export CADUCEUSLIB=`pwd`/../../lib/why

# C files to parse with success
echo "C parsing (good)"
cd good/syntax
parsing="../../../../bin/caduceus.opt -parse-only"
for f in *.c; do
    echo -n "  "$f"... "
    if ! gcc -c $f > /dev/null 2>&1; then
	echo "GCC failed"
	if test $f != "obfuscated.c" ; then
           gcc -c $f
	   exit 1
        fi
    else
      echo -n "GCC ok... "
    fi
    if ! $parsing  $f > /dev/null 2>&1; then
	echo "caduceus FAILED"
	#$parsing $f
	#exit 1
    else
	echo "caduceus ok... "
    fi
done

echo "C parsing (bad)"
cd ../../bad-syn
parsing="../../../bin/caduceus.opt -parse-only"
for f in *.c; do
    echo -n "  "$f"... "
    if gcc -c $f > /dev/null 2>&1; then
	echo "GCC failed (accepted a bad file)"
	gcc -c $f
	exit 1
    fi
    echo -n "GCC ok... "
    if $parsing  $f > /dev/null 2>&1; then
	echo "caduceus FAILED (accepted a bad file)"
	#$parsing $f
	#exit 1
    else
	echo "caduceus ok... "
    fi
done

echo "C parsing/typing (bad)"
cd ../bad-sem
parsing="../../../bin/caduceus.opt -type-only"
for f in *.c; do
    echo -n "  "$f"... "
    if gcc -c $f > /dev/null 2>&1; then
	echo "GCC failed (accepted a bad file)"
	gcc -c $f
	exit 1
    fi
    echo -n "GCC ok... "
    if $parsing  $f > /dev/null 2>&1; then
	echo "caduceus FAILED (accepted a bad file)"
	#$parsing $f
	#exit 1
    else
	echo "caduceus ok... "
    fi
done

echo "C parsing/typing (good)"
cd ../good
parsing="../../../bin/caduceus.opt -type-only"
for f in *.c; do
    echo -n "  "$f"... "
    if ! gcc -c $f > /dev/null 2>&1; then
	echo "GCC failed"
	gcc -c $f
	exit 1
    fi
    echo -n "GCC ok... "
    if ! $parsing  $f > /dev/null 2>&1; then
	echo "caduceus FAILED"
	#$parsing $f
	#exit 1
    else
	echo "caduceus ok... "
    fi
done

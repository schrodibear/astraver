#!/bin/sh

# auto bench for why

pgm=$1
coqc="coqc -I ../lib/coq"

goods () {
    for f in $1/*.mlw; do
	echo -n "  "$f"... "
	base=$1/`basename $f .mlw`
	if $pgm --coq $f > /dev/null 2>&1; then
	    echo -n "why ok... "
	    if $coqc "$base"_why.v > /dev/null 2>&1; then
		echo "coq ok"
	    else
		echo "coq FAILED"
	    fi
	else 
	    echo "why FAILED"
	    $pgm --coq $f
	    exit 1
	fi
    done
}

bads () {
    for f in $1/*.mlw; do
	echo -n "  "$f"... "
	if $pgm $2 $f > /dev/null 2>&1; then 
	    echo "$pgm $2 $f"
	    echo "FAILED!"
	    exit 1 
        else 
	    echo "ok"
	fi
    done
}

# 1. Syntax
echo "=== Checking parsing errors ==="
bads bad/syntax --parse-only
echo ""

# 2. Typing
echo "=== Checking typing errors ==="
bads bad/typing --type-only
echo ""

# 2. Other
echo "=== Checking other errors ==="
bads bad/other
echo ""

# 3. Benchmark
echo "=== Checking good files ==="
goods good

exit 0

# 4. Showing the results
for f in good/*.mlw; do
    coq=good/`basename $f .mlw`_why.v
    echo "==== "$coq" ===="
    cat $coq
    echo "==== "$f" ===="
    cat $f
    read foo
done

